name: üöÄ Deploy Server Updates

on:
  push:
    tags:
      - 'update-*'    # update-2024-01-15, update-security
      - 'v*'          # v1.0.0, v2.1.3
      - 'upgrade-*'   # upgrade-emergency

jobs:
  deploy-and-update:
    runs-on: ubuntu-latest
    name: üì¶ Deploy and Execute Update Script
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # –®–∞–≥ 2: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ø–ª–æ–µ
    - name: ‚ÑπÔ∏è Display deployment info
      run: |
        echo "=========================================="
        echo "üéØ DEPLOYMENT TRIGGERED"
        echo "=========================================="
        echo "üìå Tag: ${{ github.ref_name }}"
        echo "üë§ User: ${{ github.actor }}"
        echo "üìÅ Repo: ${{ github.repository }}"
        echo "üïê Time: $(date)"
        echo "=========================================="

    # –®–∞–≥ 3: –î–µ–ø–ª–æ–π –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
    - name: ‚ö° Deploy and run update script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üöÄ Starting deployment process..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
          cd /home/${{ secrets.SERVER_USER }}/update-server
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
          echo "üì• Updating repository code..."
          git fetch --tags
          git reset --hard ${{ github.ref }}

          # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
          export SUDO_PASSWORD="${{ secrets.SUDO_PASSWORD }}"
          
          # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
          chmod +x scripts/server-update.sh
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –ø–µ—Ä–µ–¥–∞—á–µ–π —Ç–µ–≥–∞
          echo "üîß Executing update script..."
          ./scripts/server-update.sh --tag "${{ github.ref_name }}"
          
          echo "üéâ Deployment and update completed successfully!"